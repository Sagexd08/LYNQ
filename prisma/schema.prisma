datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum UserStatus {
  active
  blocked
}

enum LoanStatus {
  active
  repaid
  overdue
}

model User {
  id        String   @id @default(uuid())
  phone     String   @unique
  status    UserStatus @default(active)
  createdAt DateTime @default(now()) @map("created_at")

  loans      Loan[]
  reputation Reputation?

  @@map("users")
}

model Loan {
  id                   String     @id @default(uuid())
  userId               String     @map("user_id")
  amount               Int
  issuedAt             DateTime   @default(now()) @map("issued_at")
  dueAt                DateTime   @map("due_at")
  status               LoanStatus @default(active)
  lateDays             Int        @default(0) @map("late_days")
  partialExtensionUsed Boolean    @default(false) @map("partial_extension_used")

  user       User        @relation(fields: [userId], references: [id])
  repayments Repayment[]

  @@map("loans")
}

model Repayment {
  id     String   @id @default(uuid())
  loanId String   @map("loan_id")
  amount Int
  paidAt DateTime @default(now()) @map("paid_at")

  loan   Loan     @relation(fields: [loanId], references: [id])

  @@map("repayments")
}

model Reputation {
  userId                    String   @id @map("user_id")
  score                     Int      @default(50)
  consecutiveLateCount      Int      @default(0) @map("consecutive_late_count")
  cleanCycleCount           Int      @default(0) @map("clean_cycle_count")
  maxScoreBeforeLastPenalty Int?     @map("max_score_before_last_penalty")
  updatedAt                 DateTime @default(now()) @map("updated_at")

  user   User              @relation(fields: [userId], references: [id])
  events ReputationEvent[]

  @@map("reputation")
}

enum ReputationEventType {
  EARLY_REPAYMENT
  ON_TIME_REPAYMENT
  PARTIAL_REPAYMENT
  LATE_REPAYMENT
  CONSECUTIVE_LATE_BLOCK
  RECOVERY
  UNBLOCK
  ADMIN_ADJUSTMENT
}

model ReputationEvent {
  id            String              @id @default(uuid())
  userId        String              @map("user_id")
  type          ReputationEventType
  delta         Int
  previousScore Int                 @map("previous_score")
  newScore      Int                 @map("new_score")
  loanId        String?             @map("loan_id")
  reason        String?
  createdAt     DateTime            @default(now()) @map("created_at")

  reputation Reputation @relation(fields: [userId], references: [userId])

  @@index([userId, createdAt])
  @@map("reputation_events")
}

